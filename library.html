<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sai Karun - Digital Archive (Admin Enabled)</title>
    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; overflow: hidden; background: #e0e0e0; font-family: 'Georgia', serif; user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; display: block; background: radial-gradient(circle at center, #ffffff 0%, #cfd8dc 100%); }

        /* HEADER */
        #header {
            position: absolute; top: 20px; left: 30px; z-index: 10;
            border-left: 5px solid #795548; padding-left: 15px;
        }
        h1 { margin: 0; font-size: 28px; color: #3e2723; letter-spacing: -0.5px; }
        .subtitle { font-family: 'Segoe UI', sans-serif; font-size: 13px; color: #5d4037; margin-top: 5px; font-weight: 600; text-transform: uppercase; }
        .stats { font-family: 'Segoe UI', sans-serif; font-size: 11px; color: #d84315; margin-top: 5px; font-weight: bold; }

        /* AUTH & ADMIN UI */
        #auth-panel { position: absolute; top: 20px; right: 30px; z-index: 20; display: flex; gap: 10px; }
        .btn {
            background: rgba(255,255,255,0.9); border: 1px solid #bcaaa4; padding: 8px 16px; border-radius: 4px;
            font-family: 'Segoe UI', sans-serif; font-size: 12px; font-weight: bold; color: #4e342e;
            cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { background: #fff; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); color: #d84315; }
        .btn-primary { background: #5d4037; color: white; border: none; }
        .btn-primary:hover { background: #3e2723; color: white; }
        .btn-danger { background: #c62828; color: white; border: none; }
        .btn-danger:hover { background: #b71c1c; }

        /* NAVIGATION HUD */
        #nav-hud {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; gap: 15px; z-index: 20;
            border: 1px solid #d7ccc8;
        }
        .nav-icon { 
            cursor: pointer; font-size: 18px; color: #5d4037; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; 
        }
        .nav-icon:hover { background: #efebe9; color: #d84315; transform: scale(1.1); }

        /* RACK LABELS */
        .shelf-label {
            position: absolute; pointer-events: none; transform: translate(-50%, -50%);
            font-family: 'Segoe UI', sans-serif; font-weight: bold; font-size: 11px; color: #5d4037;
            background: rgba(255,255,255,0.85); padding: 3px 8px; border-radius: 3px;
            border: 1px solid #d7ccc8; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-transform: uppercase; letter-spacing: 0.5px; opacity: 0; transition: opacity 0.3s;
        }

        /* DETAIL PANEL */
        #detail-card {
            position: absolute; top: 50%; right: 40px; transform: translateY(-50%) translateX(120%); 
            width: 320px; background: rgba(255, 255, 255, 0.98); border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25); padding: 30px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 15; border-top: 4px solid #795548;
        }
        #detail-card.active { transform: translateY(-50%) translateX(0); }
        .d-cat { font-family: 'Segoe UI'; font-size: 10px; text-transform: uppercase; color: #d84315; font-weight: bold; letter-spacing: 1px; }
        .d-title { font-size: 22px; margin: 10px 0 20px 0; color: #222; line-height: 1.3; }
        .d-meta { display: flex; justify-content: space-between; font-family: 'Segoe UI'; font-size: 12px; color: #777; border-bottom: 1px solid #eee; padding: 8px 0; }
        .d-val { color: #333; font-weight: 600; text-align: right; max-width: 65%; }
        
        /* Admin Actions in Detail Card */
        #admin-actions { display: none; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .action-btn { flex: 1; padding: 8px; border: none; border-radius: 3px; cursor: pointer; color: white; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        
        /* MODALS */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal {
            background: white; padding: 30px; border-radius: 6px; width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid #e0e0e0;
        }
        .inp-g { margin-bottom: 15px; }
        .inp-g label { display: block; font-family: 'Segoe UI'; font-size: 11px; color: #555; margin-bottom: 5px; font-weight: bold; }
        .inp-g input, .inp-g select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: 'Segoe UI'; }
        .inp-g input:focus { border-color: #d84315; outline: none; }

    </style>
</head>
<body>

    <div id="header">
        <h1>Sai Karun Nandipati</h1>
        <div class="subtitle">Classic Digital Archive</div>
        <div class="stats">42 Items | API Score: 415</div>
    </div>

    <div id="auth-panel">
        <button id="btn-login" class="btn" onclick="openModal('login')">Admin Login</button>
        <button id="btn-add" class="btn btn-primary" onclick="openItemModal()" style="display:none;">+ Add Item</button>
        <button id="btn-logout" class="btn" onclick="doLogout()" style="display:none;">Logout</button>
    </div>

    <div id="nav-hud">
        <div class="nav-icon" onclick="resetCam()" title="Reset View">⟲</div>
        <div style="width:1px; background:#ddd; margin:0 5px;"></div>
        <div class="nav-icon" onclick="moveCam(2)" title="Move Up">▲</div>
        <div class="nav-icon" onclick="moveCam(-2)" title="Move Down">▼</div>
        <div style="width:1px; background:#ddd; margin:0 5px;"></div>
        <div class="nav-icon" onclick="zoomCam(-3)" title="Zoom In">+</div>
        <div class="nav-icon" onclick="zoomCam(3)" title="Zoom Out">-</div>
    </div>

    <div id="detail-card">
        <div class="d-cat" id="d-cat">Category</div>
        <div class="d-title" id="d-title">Title</div>
        <div class="d-meta"><span>Author</span><span class="d-val" id="d-auth">-</span></div>
        <div class="d-meta"><span>Year</span><span class="d-val" id="d-year">-</span></div>
        <div class="d-meta"><span>Spine Label</span><span class="d-val" id="d-spine">-</span></div>
        
        <a id="d-link" href="#" target="_blank" class="btn" style="display:block; text-align:center; text-decoration:none; margin-top:20px; background:#f5f5f5;">View Source</a>
        
        <div id="admin-actions">
            <button class="action-btn" style="background:#388e3c;" onclick="editCurrentItem()">Edit Details</button>
            <button class="action-btn btn-danger" onclick="deleteCurrentItem()">Delete</button>
        </div>

        <div onclick="closeDetail()" style="text-align:center; margin-top:15px; font-size:11px; color:#aaa; cursor:pointer;">[ Close Panel ]</div>
    </div>

    <div id="modal-login" class="overlay">
        <div class="modal" style="text-align:center;">
            <h3 style="margin-top:0; color:#3e2723;">Administrator Access</h3>
            <p style="font-size:12px; color:#666; margin-bottom:20px;">Please authenticate to edit the archive.</p>
            <div class="inp-g"><input type="text" id="u-name" placeholder="Username (nsk)"></div>
            <div class="inp-g"><input type="password" id="u-pass" placeholder="Password (nsk)"></div>
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="doLogin()">Authenticate</button>
            <div style="margin-top:15px; font-size:11px; cursor:pointer; color:#888;" onclick="closeModal('login')">Return to Guest Mode</div>
        </div>
    </div>

    <div id="modal-item" class="overlay">
        <div class="modal">
            <h3 id="modal-title" style="margin-top:0; color:#3e2723; border-bottom:1px solid #eee; padding-bottom:15px;">Modify Archive</h3>
            <form onsubmit="saveItem(event)">
                <input type="hidden" id="inp-id">
                <div class="inp-g">
                    <label>Rack Placement</label>
                    <select id="inp-cat">
                        <option value="Research">Rack 1: Research Papers</option>
                        <option value="Book1">Rack 2: Books (A-H)</option>
                        <option value="Book2">Rack 3: Books (I-P)</option>
                        <option value="Book3">Rack 4: Books (Q-Z) & Projects</option>
                    </select>
                </div>
                <div class="inp-g"><label>Full Title</label><input type="text" id="inp-title" required></div>
                <div class="inp-g"><label>Spine Label (Max 15 chars)</label><input type="text" id="inp-spine" maxlength="15" required></div>
                <div class="inp-g"><label>Author / Organization</label><input type="text" id="inp-auth" required></div>
                <div class="inp-g"><label>Year</label><input type="text" id="inp-year" required></div>
                <div class="inp-g" style="display:flex; gap:10px; align-items:center;">
                    <div style="flex:1;"><label>Cover Color</label><input type="color" id="inp-color" value="#5d4037" style="height:40px; padding:2px;"></div>
                    <div style="flex:3;"><label>External Link</label><input type="url" id="inp-link" placeholder="https://..."></div>
                </div>
                <div style="text-align:right; margin-top:25px;">
                    <button type="button" class="btn" onclick="closeModal('item')" style="margin-right:10px;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="canvas-container"></div>
    <div id="labels-container" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. DATA & STATE ---
        const RAW_DATA = [
            // RACK 1: RESEARCH
            { id: 1, category: "Research", title: "Review on ML for Student Performance", spine: "ML REVIEW", author: "UIJES", year: "2025", color: "#eeeeee", link: "https://doi.org/10.53414/UIJES.5.2.21" },
            { id: 2, category: "Research", title: "Quality of LLM-Mediated Communication", spine: "LLM COMM", author: "Odebiyi E.S.", year: "2025", color: "#e0e0e0", link: "https://scholar.google.com" },
            { id: 3, category: "Research", title: "Integrating PPO for AUV Control", spine: "AUV PPO", author: "Gazi Univ", year: "2025", color: "#d6d6d6", link: "#" },
            { id: 4, category: "Research", title: "Intrusion Detection in Health Care", spine: "IDS HEALTH", author: "ICRIT-24", year: "2024", color: "#cccccc", link: "#" },
            { id: 5, category: "Research", title: "Frontiers of Innovation in Deep Learning", spine: "DL FRONTIER", author: "ICRIT-24", year: "2024", color: "#c2c2c2", link: "#" },
            { id: 6, category: "Research", title: "Local LLM Decentralized Intel", spine: "LOCAL LLM", author: "ICRIT-24", year: "2024", color: "#bdbdbd", link: "#" },
            { id: 7, category: "Research", title: "WRNN-Driven Detection for Leukemia", spine: "WRNN MED", author: "Unpublished", year: "2024", color: "#b0bec5", link: "https://doi.org/10.13140/RG.2.2.28151.23202" },
            { id: 8, category: "Research", title: "Recent Trends in DL Algorithms", spine: "DL TRENDS", author: "Emerging", year: "2023", color: "#cfd8dc", link: "#" },
            // RACK 2: BOOKS A-H
            { id: 9, category: "Book1", title: "Agentic AI: Autonomous Systems", spine: "AGENTIC AI", author: "N.S.Sai Karun", year: "2025", color: "#b71c1c", link: "https://www.amazon.com/dp/B0DV96JFYY" },
            { id: 10, category: "Book1", title: "AI Education Strategies", spine: "AI CURRICULUM", author: "N.S.Sai Karun", year: "2025", color: "#0d47a1", link: "#" },
            { id: 11, category: "Book1", title: "AI in Commerce", spine: "AI COMMERCE", author: "Mrs. V.N.V.S Mani", year: "2025", color: "#1b5e20", link: "https://www.amazon.com/dp/B0F6VF52PS" },
            { id: 12, category: "Book1", title: "AI in E-Commerce", spine: "AI E-SHOP", author: "L Sri latha", year: "2025", color: "#e65100", link: "https://www.amazon.com/dp/B0F6T38NNL" },
            { id: 13, category: "Book1", title: "AI in Education", spine: "AI EDU", author: "N.S.Sai Karun", year: "2025", color: "#4a148c", link: "https://www.amazon.com/dp/B0FMR2VFV8" },
            { id: 14, category: "Book1", title: "AI in the Classroom", spine: "AI CLASS", author: "N.S.Sai Karun", year: "2025", color: "#006064", link: "https://www.amazon.com/dp/B0DXVQFCP1" },
            { id: 15, category: "Book1", title: "Artificial Intelligence - Intellect Born", spine: "AI INTELLECT", author: "N.S.Sai Karun", year: "2025", color: "#3e2723", link: "#" },
            { id: 16, category: "Book1", title: "AI in Biomedical Research", spine: "AI BIOMED", author: "N.S.Sai Karun", year: "2025", color: "#880e4f", link: "https://www.amazon.com/dp/B0F4XTXTWN" },
            { id: 17, category: "Book1", title: "Augmented Creativity", spine: "AUG CREATE", author: "N.S.Sai Karun", year: "2025", color: "#1a237e", link: "#" },
            { id: 18, category: "Book1", title: "Building Multi-Agent Systems", spine: "MULTI-AGENT", author: "N.S.Sai Karun", year: "2025", color: "#bf360c", link: "https://www.amazon.com/dp/B0F2T9DXR3" },
            { id: 19, category: "Book1", title: "Data Mining Concepts", spine: "DATA MINE", author: "N.S.Sai Karun", year: "2025", color: "#004d40", link: "https://www.amazon.com/dp/B0FQT45KWF" },
            // RACK 3: BOOKS I-P
            { id: 20, category: "Book2", title: "Digital Marketing Fundamentals", spine: "DIGI MKTG", author: "N.S.Sai Karun", year: "2025", color: "#33691e", link: "#" },
            { id: 21, category: "Book2", title: "Foundations of RAG", spine: "RAG LLM", author: "J.Balaji", year: "2025", color: "#01579b", link: "https://www.amazon.com/dp/B0F61XXJX9" },
            { id: 22, category: "Book2", title: "Generative AI Applications", spine: "GEN AI", author: "N.S.Sai Karun", year: "2025", color: "#ff6f00", link: "https://www.amazon.com/dp/B0DTJ17RML" },
            { id: 23, category: "Book2", title: "Human 2.0: AI Evolution", spine: "HUMAN 2.0", author: "N.S.Sai Karun", year: "2025", color: "#263238", link: "https://www.amazon.com/dp/B0F48LMTJW" },
            { id: 24, category: "Book2", title: "JavaScript in Action (Pothi)", spine: "JS ACT I", author: "N.S.Sai Karun", year: "2025", color: "#f9a825", link: "https://store.pothi.com/book/n-s-sai-karun-javascript-action-100-practical-projects-boost-your-skills/" },
            { id: 25, category: "Book2", title: "JavaScript in Action (Amazon)", spine: "JS ACT II", author: "N.S.Sai Karun", year: "2025", color: "#fbc02d", link: "https://www.amazon.com/dp/B0DVLMLVXR" },
            { id: 26, category: "Book2", title: "Journey with Python", spine: "PYTHON", author: "N.S.Sai Karun", year: "2025", color: "#303f9f", link: "#" },
            { id: 27, category: "Book2", title: "Linux Essentials 101", spine: "LINUX 101", author: "N.S.Sai Karun", year: "2025", color: "#d84315", link: "#" },
            { id: 28, category: "Book2", title: "Leveraging Chatbots (Chapter)", spine: "CHATBOTS", author: "N.S.Sai Karun", year: "2025", color: "#512da8", link: "#" },
            { id: 29, category: "Book2", title: "Mastering MEAN Stack", spine: "MEAN STACK", author: "Phani Raja", year: "2025", color: "#2e7d32", link: "https://www.amazon.com/dp/B0F3P9HBXN" },
            { id: 30, category: "Book2", title: "Mastering Java", spine: "JAVA", author: "Sharmila Sk", year: "2025", color: "#c62828", link: "https://www.amazon.com/dp/B0FBV64K8N" },
            // RACK 4: BOOKS Q-Z + INNOVATION
            { id: 31, category: "Book3", title: "Mastering UI Design", spine: "UI DESIGN", author: "N.S.Sai Karun", year: "2025", color: "#00838f", link: "https://www.amazon.com/dp/B0DXVDY5DY" },
            { id: 32, category: "Book3", title: "Mini Projects Using Python", spine: "PY MINI", author: "N.S.Sai Karun", year: "2025", color: "#455a64", link: "https://www.amazon.com/dp/B0FWRXWQV2" },
            { id: 33, category: "Book3", title: "No Code Development", spine: "NO CODE", author: "N.S.Sai Karun", year: "2025", color: "#ad1457", link: "#" },
            { id: 34, category: "Book3", title: "Prompt Engineering", spine: "PROMPT", author: "N.S.Sai Karun", year: "2025", color: "#6a1b9a", link: "#" },
            { id: 35, category: "Book3", title: "Research Methodology IPR", spine: "RESEARCH IPR", author: "N.S.Sai Karun", year: "2025", color: "#283593", link: "https://www.amazon.com/dp/B0DWN7BRB1" },
            { id: 36, category: "Book3", title: "Social Network Analysis", spine: "SNA", author: "N.S.Sai Karun", year: "2025", color: "#0277bd", link: "https://www.amazon.com/dp/B0F8BPFKHY" },
            { id: 37, category: "Book3", title: "The Complete Guide to Web 3.0", spine: "WEB 3.0", author: "N.S.Sai Karun", year: "2025", color: "#00695c", link: "https://www.amazon.com/dp/B0DTN28ZBG" },
            { id: 38, category: "Book3", title: "Transform Ideas into AI Projects", spine: "AI IDEAS", author: "N.S.Sai Karun", year: "2025", color: "#ef6c00", link: "https://www.amazon.com/dp/B0F2GSWHSX" },
            { id: 39, category: "Book3", title: "Web Dev: HTML, CSS, JS", spine: "WEB DEV", author: "N.S.Sai Karun", year: "2025", color: "#c62828", link: "https://www.amazon.com/dp/B0DTHXGWGQ" },
            { id: 40, category: "Book3", title: "OOSE (UML)", spine: "OOSE UML", author: "N.S.Sai Karun", year: "2025", color: "#424242", link: "https://www.amazon.com/dp/B0DTTGBHZV" },
            { id: 41, category: "Book3", title: "Asst. Professor (Project)", spine: "PROFESSOR", author: "Krishna Univ", year: "2023-24", color: "#212121", link: "#" },
            { id: 42, category: "Book3", title: "Engineering of AI-Enabled Systems", spine: "AI ENG", author: "Emerging", year: "2023", color: "#424242", link: "#" }
        ];

        let libraryData = [];
        let meshes = [];
        let selectedItem = null;
        let isAdmin = false;

        // --- 2. AUTH & CRUD LOGIC ---
        function loadDB() {
            const saved = localStorage.getItem('sk_archive_db_v3');
            libraryData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(RAW_DATA));
        }
        function saveDB() {
            localStorage.setItem('sk_archive_db_v3', JSON.stringify(libraryData));
            buildLibrary();
        }

        window.openModal = (id) => document.getElementById(`modal-${id}`).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(`modal-${id}`).style.display = 'none';
        
        // LOGIN
        window.doLogin = () => {
            const u = document.getElementById('u-name').value;
            const p = document.getElementById('u-pass').value;
            
            // CREDENTIALS CHECK
            if(u === 'nsk' && p === 'nsk') {
                isAdmin = true;
                toggleAdminUI(true);
                closeModal('login');
                alert("Welcome Admin. Editing Mode Enabled.");
            } else {
                alert("Invalid Credentials. Try 'nsk' / 'nsk'");
            }
        };

        // LOGOUT
        window.doLogout = () => {
            isAdmin = false;
            toggleAdminUI(false);
            closeDetail();
            alert("Logged Out. Guest Mode.");
        };

        function toggleAdminUI(enable) {
            document.getElementById('btn-login').style.display = enable ? 'none' : 'inline-block';
            document.getElementById('btn-add').style.display = enable ? 'inline-block' : 'none';
            document.getElementById('btn-logout').style.display = enable ? 'inline-block' : 'none';
            document.getElementById('admin-actions').style.display = enable ? 'flex' : 'none';
        }

        // ADD / EDIT
        window.openItemModal = (isEdit=false) => {
            if(!isAdmin) return alert("Please Login First");
            openModal('item');
            document.getElementById('modal-title').innerText = isEdit ? "Edit Existing Item" : "Add New Item";
            
            if(!isEdit) {
                // Clear fields for new item
                document.getElementById('inp-id').value = "";
                document.getElementById('inp-title').value = "";
                document.getElementById('inp-spine').value = "";
                document.getElementById('inp-auth').value = "";
                document.getElementById('inp-year').value = "";
                document.getElementById('inp-link').value = "";
                document.getElementById('inp-color').value = "#5d4037";
            }
        };

        window.saveItem = (e) => {
            e.preventDefault();
            const idVal = document.getElementById('inp-id').value;
            const newObj = {
                id: idVal ? parseInt(idVal) : Date.now(),
                category: document.getElementById('inp-cat').value,
                title: document.getElementById('inp-title').value,
                spine: document.getElementById('inp-spine').value,
                author: document.getElementById('inp-auth').value,
                year: document.getElementById('inp-year').value,
                color: document.getElementById('inp-color').value,
                link: document.getElementById('inp-link').value
            };

            if(idVal) {
                // UPDATE
                const idx = libraryData.findIndex(x => x.id == idVal);
                if(idx > -1) libraryData[idx] = newObj;
            } else {
                // CREATE
                libraryData.push(newObj);
            }
            saveDB();
            closeModal('item');
            if(idVal) showDetail(newObj); // Refresh detail panel
        };

        window.editCurrentItem = () => {
            if(!selectedItem) return;
            openItemModal(true);
            document.getElementById('inp-id').value = selectedItem.id;
            document.getElementById('inp-cat').value = selectedItem.category;
            document.getElementById('inp-title').value = selectedItem.title;
            document.getElementById('inp-spine').value = selectedItem.spine;
            document.getElementById('inp-auth').value = selectedItem.author;
            document.getElementById('inp-year').value = selectedItem.year;
            document.getElementById('inp-color').value = selectedItem.color;
            document.getElementById('inp-link').value = selectedItem.link;
        };

        window.deleteCurrentItem = () => {
            if(!isAdmin) return;
            if(confirm("Are you sure you want to permanently delete this item?")) {
                libraryData = libraryData.filter(i => i.id !== selectedItem.id);
                saveDB();
                closeDetail();
            }
        };

        // --- 3. THREE.JS SCENE SETUP ---
        const scene = new THREE.Scene();
        // Camera setup
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 100);
        const defaultCamPos = { x: 0, y: 0, z: 18 };
        camera.position.set(defaultCamPos.x, defaultCamPos.y, defaultCamPos.z);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Lighting
        const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambLight);
        
        const dirLight = new THREE.DirectionalLight(0xfff8e1, 1.2);
        dirLight.position.set(5, 10, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // --- 4. BUILDER FUNCTIONS ---
        // Spine Texture Generator
        function getTexture(color, text, cat) {
            const cvs = document.createElement('canvas');
            cvs.width = 128; cvs.height = 512;
            const ctx = cvs.getContext('2d');
            
            // Base
            ctx.fillStyle = color; ctx.fillRect(0,0,128,512);
            
            // Gradient Shading
            const g = ctx.createLinearGradient(0,0,128,0);
            g.addColorStop(0, "rgba(0,0,0,0.3)");
            g.addColorStop(0.2, "rgba(255,255,255,0.1)");
            g.addColorStop(0.5, "rgba(255,255,255,0)");
            g.addColorStop(0.8, "rgba(0,0,0,0.1)");
            g.addColorStop(1, "rgba(0,0,0,0.4)");
            ctx.fillStyle=g; ctx.fillRect(0,0,128,512);

            // Decorations
            if(cat.includes('Book')) {
                ctx.fillStyle="#FFD700"; // Gold bands
                ctx.fillRect(0,60,128,6);
                ctx.fillRect(0,450,128,6);
            }
            
            // Text
            ctx.save();
            ctx.translate(64, 256); 
            ctx.rotate(-Math.PI/2);
            ctx.font = "bold 24px Georgia"; 
            ctx.textAlign="center"; 
            ctx.textBaseline="middle";
            
            if(cat === 'Research') {
                ctx.fillStyle="#222"; 
            } else {
                ctx.fillStyle="#fff"; 
                ctx.shadowColor="rgba(0,0,0,0.8)"; 
                ctx.shadowBlur=4;
            }
            
            ctx.fillText(text.toUpperCase().substring(0,16), 0, 0);
            ctx.restore();

            return new THREE.CanvasTexture(cvs);
        }

        const woodMat = new THREE.MeshStandardMaterial({color: 0x5d4037, roughness: 0.6});

        function buildLibrary() {
            // Cleanup
            meshes.forEach(m => { scene.remove(m); if(m.geometry) m.geometry.dispose(); });
            meshes = [];
            document.getElementById('labels-container').innerHTML = '';

            const RACKS = [
                {id:'Research', name:'Rack 1: Research Papers', y: 5.5},
                {id:'Book1', name:'Rack 2: Books (A-H)', y: 2.0},
                {id:'Book2', name:'Rack 3: Books (I-P)', y: -1.5},
                {id:'Book3', name:'Rack 4: Books (Q-Z) & Innovation', y: -5.0}
            ];

            RACKS.forEach(rack => {
                // Shelf
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(11, 0.2, 1.5), woodMat);
                shelf.position.set(0, rack.y, 0);
                shelf.receiveShadow = true;
                scene.add(shelf); meshes.push(shelf);

                // HTML Label
                const lb = document.createElement('div');
                lb.className = 'shelf-label';
                lb.innerText = rack.name;
                document.getElementById('labels-container').appendChild(lb);
                shelf.userData = { isShelf:true, label:lb, y: rack.y };

                // Items
                const items = libraryData.filter(i => i.category === rack.id);
                if(items.length > 0) {
                    const w = 0.42; // Item width spacing
                    const startX = -((items.length * w) / 2) + (w/2);

                    items.forEach((item, i) => {
                        // Dimensions
                        let h = 1.3, d = 1.0;
                        if(rack.id === 'Research') { h = 1.1; d = 0.15; }

                        const geo = new THREE.BoxGeometry(0.35, h, d);
                        const tex = getTexture(item.color, item.spine, rack.id);
                        tex.colorSpace = THREE.SRGBColorSpace;

                        const matSpine = new THREE.MeshStandardMaterial({map:tex});
                        const matCover = new THREE.MeshStandardMaterial({color: item.color});
                        const matPages = new THREE.MeshStandardMaterial({color: 0xfffff0});

                        // Materials: R, L, Top, Bot, Front, Back
                        const mats = [matCover, matCover, matPages, matPages, matSpine, matPages];

                        const mesh = new THREE.Mesh(geo, mats);
                        mesh.position.set(startX + (i*w), rack.y + (h/2) + 0.1, 0);
                        
                        // Random tilt
                        mesh.rotation.y = (Math.random() * 0.1) - 0.05;
                        mesh.position.z = (Math.random() * 0.1);

                        mesh.castShadow = true;
                        mesh.userData = { isItem:true, data: item, origZ: mesh.position.z };
                        scene.add(mesh); meshes.push(mesh);
                    });
                }
            });

            // Back Panel
            const back = new THREE.Mesh(new THREE.BoxGeometry(12, 16, 0.5), woodMat);
            back.position.set(0, 0, -1);
            back.receiveShadow = true;
            scene.add(back); meshes.push(back);
        }

        // --- 5. INTERACTION & NAV ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hovered = null;

        // Hover Effect
        window.addEventListener('mousemove', e => {
            mouse.x = (e.clientX/window.innerWidth)*2-1;
            mouse.y = -(e.clientY/window.innerHeight)*2+1;
            
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(meshes);
            const hit = hits.find(x => x.object.userData.isItem);

            if(hovered && (!hit || hit.object !== hovered)) {
                // Mouse out
                new TWEEN.Tween(hovered.position).to({z: hovered.userData.origZ}, 200).start();
                document.body.style.cursor = 'default';
                hovered = null;
            }
            if(hit && hovered !== hit.object) {
                // Mouse over
                hovered = hit.object;
                document.body.style.cursor = 'pointer';
                new TWEEN.Tween(hovered.position).to({z: hovered.userData.origZ + 0.6}, 200).easing(TWEEN.Easing.Cubic.Out).start();
            }
        });

        // Click to Open
        window.addEventListener('click', () => {
            if(hovered) {
                showDetail(hovered.userData.data);
            }
        });

        window.showDetail = (item) => {
            selectedItem = item;
            document.getElementById('d-cat').innerText = item.category;
            document.getElementById('d-title').innerText = item.title;
            document.getElementById('d-auth').innerText = item.author;
            document.getElementById('d-year').innerText = item.year;
            document.getElementById('d-spine').innerText = item.spine;
            
            const lnk = document.getElementById('d-link');
            if(item.link && item.link.length > 3) {
                lnk.href = item.link;
                lnk.style.display = 'block';
            } else {
                lnk.style.display = 'none';
            }
            
            document.getElementById('detail-card').classList.add('active');
        };
        window.closeDetail = () => document.getElementById('detail-card').classList.remove('active');

        // --- NAVIGATION API ---
        window.moveCam = (yDelta) => {
            new TWEEN.Tween(camera.position)
                .to({ y: camera.position.y + yDelta }, 500)
                .easing(TWEEN.Easing.Cubic.Out)
                .start();
        };

        window.zoomCam = (zDelta) => {
            let newZ = camera.position.z + zDelta;
            if(newZ < 5) newZ = 5; // Min zoom
            if(newZ > 25) newZ = 25; // Max zoom
            new TWEEN.Tween(camera.position)
                .to({ z: newZ }, 500)
                .easing(TWEEN.Easing.Cubic.Out)
                .start();
        };

        window.resetCam = () => {
            new TWEEN.Tween(camera.position)
                .to({ x: defaultCamPos.x, y: defaultCamPos.y, z: defaultCamPos.z }, 800)
                .easing(TWEEN.Easing.Back.Out)
                .start();
        };

        // --- INIT ---
        loadDB();
        buildLibrary();

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();

            // Sync HTML Labels
            meshes.forEach(m => {
                if(m.userData.isShelf && m.userData.label) {
                    const v = new THREE.Vector3(0, m.userData.y + 1, 0); // Label pos
                    v.project(camera);
                    
                    const x = (v.x * .5 + .5) * window.innerWidth;
                    const y = (v.y * -.5 + .5) * window.innerHeight;
                    
                    if(Math.abs(v.z) < 1 && Math.abs(v.x) < 1) {
                        m.userData.label.style.left = x + 'px';
                        m.userData.label.style.top = y + 'px';
                        m.userData.label.style.opacity = 1;
                    } else {
                        m.userData.label.style.opacity = 0;
                    }
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
